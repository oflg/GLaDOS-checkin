name: GLaDOS Checkin with Notify

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©ä¸Šåˆ 10:00 è‡ªåŠ¨è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install requests
        run: pip install requests

      - name: Run Checkin & Notify
        env:
          GLADOS_COOKIE: ${{ secrets.COOKIE }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
        run: |
          python -c "
          import requests
          import os
          import json
          import sys

          # --- 1. å‘é€ Telegram é€šçŸ¥çš„å‡½æ•° ---
          def send_telegram(message):
              token = os.environ.get('TG_TOKEN')
              chat_id = os.environ.get('TG_ID')
              if not token or not chat_id:
                  print('âš ï¸ æœªé…ç½® Telegramï¼Œè·³è¿‡é€šçŸ¥')
                  return
              
              tg_url = f'https://api.telegram.org/bot{token}/sendMessage'
              data = {
                  'chat_id': chat_id,
                  'text': message,
                  'parse_mode': 'Markdown'
              }
              try:
                  r = requests.post(tg_url, json=data)
                  if r.status_code == 200:
                      print('ğŸ“¢ Telegram é€šçŸ¥å‘é€æˆåŠŸ')
                  else:
                      print(f'âš ï¸ é€šçŸ¥å‘é€å¤±è´¥: {r.text}')
              except Exception as e:
                  print(f'âš ï¸ é€šçŸ¥å‘é€å¼‚å¸¸: {e}')

          # --- 2. ä¸»é€»è¾‘ ---
          cookie = os.environ.get('GLADOS_COOKIE')
          if not cookie:
              print('âŒ é”™è¯¯: æœªæ‰¾åˆ° Cookie')
              exit(1)

          url = 'https://glados.rocks/api/user/checkin'
          headers = {
              'cookie': cookie,
              'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
              'content-type': 'application/json;charset=UTF-8',
              'origin': 'https://glados.rocks',
              'referer': 'https://glados.rocks/console/checkin'
          }
          payload = {'token': 'glados.one'}

          log_msg = ''
          
          try:
              print('â³ å¼€å§‹ç­¾åˆ°...')
              response = requests.post(url, headers=headers, json=payload)
              res_json = response.json()
              code = res_json.get('code')
              msg = res_json.get('message')
              
              # ç»„è£…é€šçŸ¥å†…å®¹
              if code == 0:
                  status = 'âœ… ç­¾åˆ°æˆåŠŸ'
                  log_msg = f'{status}\nä¿¡æ¯: {msg}'
              elif code == 1:
                  status = 'ğŸŸ¡ å·²ç­¾åˆ°'
                  log_msg = f'{status}\nä¿¡æ¯: {msg}'
              elif code == -2:
                  status = 'âŒ Cookie è¿‡æœŸ'
                  log_msg = f'{status}\nè¯·å» GitHub æ›´æ–° Secrets!'
              else:
                  status = 'âŒ æœªçŸ¥çŠ¶æ€'
                  log_msg = f'{status}\nCode: {code}\nMsg: {msg}'
              
              print(log_msg)
              
              # å‘é€é€šçŸ¥
              send_telegram(f'*GLaDOS ç­¾åˆ°æŠ¥å‘Š*\n----------------\n{log_msg}')

          except Exception as e:
              err_msg = f'âŒ è„šæœ¬è¿è¡Œå‡ºé”™: {e}'
              print(err_msg)
              send_telegram(err_msg)
              exit(1)
          "

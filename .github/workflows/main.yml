name: GLaDOS Auto Checkin

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©ä¸Šåˆ 10:00 è‡ªåŠ¨è¿è¡Œ (UTC æ—¶é—´ 2:00)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®æµ‹è¯•

jobs:
  checkin:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Run Checkin
        env:
          # è¿™é‡Œä¼šè¯»å–ä½ åœ¨ Settings é‡Œå¡«å†™çš„ COOKIE
          GLADOS_COOKIE: ${{ secrets.COOKIE }}
        run: |
          python -c "
          import requests
          import os
          import json

          # 1. è·å– Cookie
          cookie = os.environ.get('GLADOS_COOKIE')
          if not cookie:
              print('âŒ é”™è¯¯: æœªæ‰¾åˆ° Cookieï¼Œè¯·æ£€æŸ¥ Settings > Secrets')
              exit(1)

          # 2. è®¾ç½®è¯·æ±‚å¤´ï¼Œä¼ªè£…æˆæµè§ˆå™¨
          url = 'https://glados.rocks/api/user/checkin'
          headers = {
              'cookie': cookie,
              'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
              'content-type': 'application/json;charset=UTF-8',
              'origin': 'https://glados.rocks',
              'referer': 'https://glados.rocks/console/checkin'
          }
          payload = {'token': 'glados.one'}

          print('â³ å¼€å§‹å°è¯•ç­¾åˆ°...')
          try:
              # å‘é€è¯·æ±‚
              response = requests.post(url, headers=headers, json=payload)
              print(f'ğŸ“¡ çŠ¶æ€ç : {response.status_code}')
              
              # è§£æç»“æœ
              res_json = response.json()
              msg = res_json.get('message')
              code = res_json.get('code')
              
              # 3. åˆ¤æ–­ç»“æœ
              if code == 0:
                  print(f'âœ… ç­¾åˆ°æˆåŠŸ! è·å¾—ç‚¹æ•°ã€‚æ¶ˆæ¯: {msg}')
              elif code == 1:
                  print(f'ğŸŸ¡ ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ã€‚æ¶ˆæ¯: {msg}')
              elif code == -2:
                   print(f'âŒ Cookie å·²è¿‡æœŸï¼Œè¯·å» GitHub Secrets æ›´æ–°ï¼æ¶ˆæ¯: {msg}')
                   exit(1) # æ ‡è®°ä¸ºå¤±è´¥ï¼ŒGitHub ä¼šå‘é‚®ä»¶é€šçŸ¥ä½ 
              else:
                  print(f'âŒ æœªçŸ¥çŠ¶æ€: {code}, æ¶ˆæ¯: {msg}')
                  
          except Exception as e:
              print(f'âŒ è„šæœ¬è¿è¡Œå‡ºé”™: {e}')
              exit(1)
          "
